name: Publish to AWS CodeArtifact

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 912675023810
  PROJECT_NAME: hasslefree
  CODEARTIFACT_DOMAIN: hasslefree-dev
  CODEARTIFACT_REPOSITORY: maven

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: Publish auth-client-lib to CodeArtifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-${{ github.actor }}-${{ github.run_id }}-codeartifact

      - name: Verify CodeArtifact repository exists
        run: |
          echo "=== Checking CodeArtifact repository ==="
          aws codeartifact describe-repository \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --region ${{ env.AWS_REGION }}
          echo "✓ Repository verified"

      - name: Get CodeArtifact authorization token
        run: |
          echo "=== Requesting authorization token ==="
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --region ${{ env.AWS_REGION }} \
            --duration-seconds 900 \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "❌ ERROR: Failed to obtain CodeArtifact token!"
            exit 1
          fi
          
          echo "CODEARTIFACT_AUTH_TOKEN=${CODEARTIFACT_AUTH_TOKEN}" >> $GITHUB_ENV
          echo "✓ Token obtained ($(echo -n "$CODEARTIFACT_AUTH_TOKEN" | wc -c) chars)"

      - name: Configure Maven for CodeArtifact
        env:
          CODEARTIFACT_TOKEN: ${{ env.CODEARTIFACT_AUTH_TOKEN }}
        run: |
          echo "=== Creating Maven settings.xml ==="
          mkdir -p ~/.m2
          
          # Verify we have the token
          if [ -z "$CODEARTIFACT_TOKEN" ]; then
            echo "❌ ERROR: CODEARTIFACT_TOKEN is empty!"
            exit 1
          fi
          
          # Use Python for safe token substitution (guaranteed availability)
          python3 << 'PYTHON_EOF'
          import os
          import xml.etree.ElementTree as ET
          
          token = os.environ.get('CODEARTIFACT_TOKEN', '')
          if not token:
              print("❌ ERROR: Token not found in environment!")
              exit(1)
          
          # Create settings.xml using ElementTree for proper XML generation
          settings_xml = f'''<?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>{token}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>https://hasslefree-dev-912675023810.d.codeartifact.us-east-1.amazonaws.com/maven/maven/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>'''
          
          with open(os.path.expanduser('~/.m2/settings.xml'), 'w') as f:
              f.write(settings_xml)
          
          print(f"✓ settings.xml created with token ({len(token)} chars)")
          PYTHON_EOF

      - name: Verify Maven settings
        run: |
          if [ ! -f ~/.m2/settings.xml ]; then
            echo "❌ ERROR: settings.xml not found!"
            exit 1
          fi
          
          SIZE=$(stat -c%s ~/.m2/settings.xml 2>/dev/null || stat -f%z ~/.m2/settings.xml 2>/dev/null)
          echo "✓ settings.xml exists (${SIZE} bytes)"
          
          # Verify server entry
          if grep -q '<id>codeartifact</id>' ~/.m2/settings.xml; then
            echo "✓ Contains codeartifact server ID"
          else
            echo "❌ ERROR: codeartifact server ID not found!"
            exit 1
          fi
          
          # Verify username
          if grep -q '<username>aws</username>' ~/.m2/settings.xml; then
            echo "✓ Contains AWS username"
          else
            echo "❌ ERROR: aws username not found!"
            exit 1
          fi
          
          # Verify password is present (but don't print it)
          if grep -q '<password>' ~/.m2/settings.xml; then
            PASSWORD_LENGTH=$(grep -oP '(?<=<password>).+?(?=</password>)' ~/.m2/settings.xml | wc -c)
            echo "✓ Contains password (${PASSWORD_LENGTH} chars)"
          else
            echo "❌ ERROR: password not found in settings.xml!"
            exit 1
          fi
          
          # Verify repository URL
          if grep -q 'hasslefree-dev-912675023810.d.codeartifact.us-east-1.amazonaws.com' ~/.m2/settings.xml; then
            echo "✓ Contains correct CodeArtifact URL"
          else
            echo "❌ ERROR: CodeArtifact URL not found!"
            exit 1
          fi

      - name: Build and Test
        run: mvn -B -ntp clean verify

      - name: Publish to CodeArtifact
        run: |
          echo "=== Publishing to CodeArtifact ==="
          echo "Domain: ${{ env.CODEARTIFACT_DOMAIN }}"
          echo "Repository: ${{ env.CODEARTIFACT_REPOSITORY }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Account: ${{ env.AWS_ACCOUNT_ID }}"
          echo ""
          
          # Verify settings.xml before deploy
          if [ ! -f ~/.m2/settings.xml ]; then
            echo "❌ ERROR: settings.xml not found before deploy!"
            exit 1
          fi
          
          # Deploy with verbose output
          mvn -B deploy \
            -DskipTests \
            -Dorg.slf4j.simpleLogger.defaultLogLevel=info \
            --settings ~/.m2/settings.xml
          
          if [ $? -eq 0 ]; then
            echo "✓ Published successfully"
          else
            echo "❌ Deploy failed - check Maven output above"
            exit 1
          fi

      - name: Publish Summary
        run: |
          echo "## ✅ Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | ${{ env.CODEARTIFACT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ env.CODEARTIFACT_REPOSITORY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | com.hasslefree:auth-client-lib |" >> $GITHUB_STEP_SUMMARY

      - name: Handle publish failure
        if: failure()
        run: |
          echo "## ❌ Publish Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify AWS credentials: \`aws sts get-caller-identity\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check CodeArtifact domain/repo: \`aws codeartifact describe-repository ...\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check IAM role permissions: \`aws iam get-role-policy ...\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Review Maven debug output: add \`-X\` flag to mvn commands" >> $GITHUB_STEP_SUMMARY

