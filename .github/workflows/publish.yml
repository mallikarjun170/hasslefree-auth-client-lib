name: Publish to AWS CodeArtifact

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 912675023810
  PROJECT_NAME: hasslefree
  CODEARTIFACT_DOMAIN: hasslefree-dev
  CODEARTIFACT_REPOSITORY: maven

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: Publish auth-client-lib to CodeArtifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-${{ github.actor }}-${{ github.run_id }}-codeartifact

      - name: Get CodeArtifact authorization token
        run: |
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --region ${{ env.AWS_REGION }} \
            --query authorizationToken \
            --output text)
          echo "CODEARTIFACT_AUTH_TOKEN=${CODEARTIFACT_AUTH_TOKEN}" >> $GITHUB_ENV

      - name: Configure Maven settings for CodeArtifact
        env:
          CODEARTIFACT_TOKEN: ${{ env.CODEARTIFACT_AUTH_TOKEN }}
        run: |
          mkdir -p ~/.m2
          
          # Use Python to safely substitute the token (guaranteed to work)
          python3 << 'PYTHON_EOF'
          import os
          
          token = os.environ.get('CODEARTIFACT_TOKEN', '')
          if not token:
              print("ERROR: CODEARTIFACT_TOKEN is empty!")
              exit(1)
          
          settings_content = """<?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>""" + token + """</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>https://hasslefree-dev-912675023810.d.codeartifact.us-east-1.amazonaws.com/maven/maven/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>"""
          
          with open(os.path.expanduser('~/.m2/settings.xml'), 'w') as f:
              f.write(settings_content)
          
          print(f"✓ Maven settings.xml created with token ({len(token)} chars)")
          print(f"✓ Token starts with: {token[:20]}...")
          PYTHON_EOF
          
          # Verify the file was created with token
          if grep -q "eyJ" ~/.m2/settings.xml; then
            echo "✓ Verification: Token is in settings.xml"
          else
            echo "✗ ERROR: Token not found in settings.xml!"
            exit 1
          fi

      - name: Build and Test
        run: mvn -B -ntp clean verify

      - name: Publish to CodeArtifact
        run: |
          echo "=== Verifying AWS credentials ==="
          aws sts get-caller-identity
          
          echo ""
          echo "=== Verifying Maven settings.xml ==="
          if [ -f ~/.m2/settings.xml ]; then
            echo "Settings file exists"
            echo "Settings file size: $(stat -f%z ~/.m2/settings.xml 2>/dev/null || stat -c%s ~/.m2/settings.xml 2>/dev/null) bytes"
          else
            echo "ERROR: settings.xml not found!"
            exit 1
          fi
          
          echo ""
          echo "=== Running Maven deploy ==="
          mvn -B deploy -DskipTests -q

      - name: Publish Summary
        run: |
          echo "## ✅ Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | ${{ env.CODEARTIFACT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ env.CODEARTIFACT_REPOSITORY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
