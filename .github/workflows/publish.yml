name: Publish to AWS CodeArtifact

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 912675023810
  PROJECT_NAME: hasslefree
  CODEARTIFACT_DOMAIN: hasslefree-dev
  CODEARTIFACT_REPOSITORY: maven

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: Publish auth-client-lib to CodeArtifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-${{ github.actor }}-${{ github.run_id }}-codeartifact

      - name: Verify CodeArtifact repository exists
        run: |
          echo "=== Checking CodeArtifact repository ==="
          aws codeartifact describe-repository \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --region ${{ env.AWS_REGION }}
          echo "✓ Repository verified"

      - name: Login to CodeArtifact
        run: |
          echo "=== Configuring Maven for CodeArtifact ==="
          aws codeartifact login --tool maven \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --region ${{ env.AWS_REGION }}
          echo "✓ Maven configured for CodeArtifact"

      - name: Verify Maven settings
        run: |
          if [ ! -f ~/.m2/settings.xml ]; then
            echo "❌ ERROR: settings.xml not created!"
            exit 1
          fi
          echo "✓ settings.xml created ($(stat -c%s ~/.m2/settings.xml) bytes)"
          echo "✓ Contains codeartifact server entry: $(grep -c 'codeartifact' ~/.m2/settings.xml || echo '0') occurrences"

      - name: Build and Test
        run: mvn -B -ntp clean verify

      - name: Publish to CodeArtifact
        run: |
          echo "=== Publishing to CodeArtifact ==="
          echo "Domain: ${{ env.CODEARTIFACT_DOMAIN }}"
          echo "Repository: ${{ env.CODEARTIFACT_REPOSITORY }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""
          mvn -B deploy -DskipTests -Dorg.slf4j.simpleLogger.defaultLogLevel=info
          echo "✓ Published successfully"

      - name: Publish Summary
        run: |
          echo "## ✅ Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | ${{ env.CODEARTIFACT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ env.CODEARTIFACT_REPOSITORY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | com.hasslefree:auth-client-lib |" >> $GITHUB_STEP_SUMMARY

      - name: Handle publish failure
        if: failure()
        run: |
          echo "## ❌ Publish Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify AWS credentials: \`aws sts get-caller-identity\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check CodeArtifact domain/repo: \`aws codeartifact describe-repository ...\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check IAM role permissions: \`aws iam get-role-policy ...\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Review Maven debug output: add \`-X\` flag to mvn commands" >> $GITHUB_STEP_SUMMARY

