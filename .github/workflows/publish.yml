name: Publish to AWS CodeArtifact

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 912675023810
  PROJECT_NAME: hasslefree
  CODEARTIFACT_DOMAIN: hasslefree-dev
  CODEARTIFACT_REPOSITORY: maven

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: Publish auth-client-lib to CodeArtifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-${{ github.actor }}-${{ github.run_id }}-codeartifact

      - name: Get CodeArtifact authorization token
        run: |
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --region ${{ env.AWS_REGION }} \
            --query authorizationToken \
            --output text)
          echo "CODEARTIFACT_AUTH_TOKEN=${CODEARTIFACT_AUTH_TOKEN}" >> $GITHUB_ENV

      - name: Configure Maven settings for CodeArtifact
        run: |
          mkdir -p ~/.m2
          # Trim whitespace from token
          CODEARTIFACT_AUTH_TOKEN=$(echo "${CODEARTIFACT_AUTH_TOKEN}" | xargs)
          
          cat > ~/.m2/settings.xml <<'SETTINGS_EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>CODEARTIFACT_TOKEN_PLACEHOLDER</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>https://${{ env.CODEARTIFACT_DOMAIN }}-${{ env.AWS_ACCOUNT_ID }}.d.codeartifact.${{ env.AWS_REGION }}.amazonaws.com/maven/maven/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>
          SETTINGS_EOF
          
          # Use printf for safer substitution with special characters
          printf '%s\n' "s|CODEARTIFACT_TOKEN_PLACEHOLDER|${CODEARTIFACT_AUTH_TOKEN}|" | sed -i -f - ~/.m2/settings.xml
          
          echo "=== Maven settings.xml content ==="
          cat ~/.m2/settings.xml
          echo "=== Token length: $(echo -n "${CODEARTIFACT_AUTH_TOKEN}" | wc -c) characters ==="

      - name: Build and Test
        run: mvn -B -ntp clean verify

      - name: Publish to CodeArtifact
        run: |
          echo "=== AWS Credentials Test ==="
          aws sts get-caller-identity
          
          echo ""
          echo "=== CodeArtifact Domain Verification ==="
          aws codeartifact describe-domain --domain ${{ env.CODEARTIFACT_DOMAIN }} --region ${{ env.AWS_REGION }}
          
          echo ""
          echo "=== Maven Deploy with Debug Output ==="
          mvn -B -X deploy -DskipTests 2>&1 | tee deploy.log
          
          echo ""
          echo "=== Checking for 403 errors in log ==="
          grep -i "403\|forbidden" deploy.log || echo "No 403 errors found"

      - name: Publish Summary
        run: |
          echo "## âœ… Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | ${{ env.CODEARTIFACT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ env.CODEARTIFACT_REPOSITORY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
