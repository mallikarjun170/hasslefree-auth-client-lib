name: Publish to AWS CodeArtifact

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 912675023810
  PROJECT_NAME: hasslefree
  CODEARTIFACT_DOMAIN: hasslefree-dev
  CODEARTIFACT_REPOSITORY: maven

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: Publish auth-client-lib to CodeArtifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-${{ github.actor }}-${{ github.run_id }}-codeartifact

      - name: Upgrade AWS CLI
        run: |
          echo "=== Checking AWS CLI version ==="
          aws --version
          echo ""
          echo "=== Upgrading AWS CLI ==="
          pip install --upgrade awscli 2>&1 | tail -5
          echo ""
          echo "=== New AWS CLI version ==="
          aws --version

      - name: Verify CodeArtifact repository exists
        run: |
          echo "=== Checking CodeArtifact repository ==="
          aws codeartifact describe-repository \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --region ${{ env.AWS_REGION }}
          echo "✓ Repository verified"

      - name: Get CodeArtifact authorization token
        run: |
          echo "=== Requesting authorization token ==="
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --region ${{ env.AWS_REGION }} \
            --duration-seconds 900 \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "❌ ERROR: Failed to obtain CodeArtifact token!"
            echo "AWS Caller Identity:"
            aws sts get-caller-identity
            exit 1
          fi
          
          echo "CODEARTIFACT_AUTH_TOKEN=${CODEARTIFACT_AUTH_TOKEN}" >> $GITHUB_ENV
          TOKEN_LEN=$(echo -n "$CODEARTIFACT_AUTH_TOKEN" | wc -c)
          echo "✓ Token obtained (${TOKEN_LEN} chars)"
          echo "Token format: JWT" 
          echo "Token expires in: 900 seconds"

      - name: Configure Maven for CodeArtifact
        env:
          CODEARTIFACT_TOKEN: ${{ env.CODEARTIFACT_AUTH_TOKEN }}
        run: |
          echo "=== Configuring Maven with CodeArtifact credentials ==="
          
          if aws codeartifact login --tool maven \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} 2>&1; then
            echo "✓ Successfully used aws codeartifact login"
          else
            echo "⚠ Using manual settings.xml approach..."
            
            mkdir -p ~/.m2
            
            TOKEN_LEN=$(echo -n "$CODEARTIFACT_TOKEN" | wc -c)
            echo "Token length: ${TOKEN_LEN} chars"
            
            cat > ~/.m2/settings.xml << SETTINGS_EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>${CODEARTIFACT_TOKEN}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>https://hasslefree-dev-912675023810.d.codeartifact.us-east-1.amazonaws.com/maven/maven/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>
          SETTINGS_EOF
            
            FILE_SIZE=$(stat -c%s ~/.m2/settings.xml 2>/dev/null || stat -f%z ~/.m2/settings.xml 2>/dev/null)
            echo "✓ settings.xml created (${FILE_SIZE} bytes)"
          fi

      - name: Build and Test
        run: mvn -B -ntp clean verify

      - name: Debug Maven settings
        run: |
          echo "=== Verifying settings.xml ==="
          if [ ! -f ~/.m2/settings.xml ]; then
            echo "❌ ERROR: settings.xml not found!"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s ~/.m2/settings.xml 2>/dev/null || stat -f%z ~/.m2/settings.xml 2>/dev/null)
          echo "✓ settings.xml exists (${FILE_SIZE} bytes)"
          echo ""
          
          # Check critical elements
          echo "=== Checking critical XML elements ==="
          if grep -q '<id>codeartifact</id>' ~/.m2/settings.xml; then
            COUNT=$(grep -c '<id>codeartifact</id>' ~/.m2/settings.xml)
            echo "✓ Found <id>codeartifact</id> ($COUNT occurrences)"
          else
            echo "❌ ERROR: <id>codeartifact</id> not found!"
            exit 1
          fi
          
          if grep -q '<username>aws</username>' ~/.m2/settings.xml; then
            echo "✓ Found <username>aws</username>"
          else
            echo "❌ ERROR: <username>aws</username> not found!"
            exit 1
          fi
          
          if grep -q '<password>' ~/.m2/settings.xml; then
            # Extract password length without exposing it
            PWD_LINE=$(grep '<password>' ~/.m2/settings.xml)
            PWD_LENGTH=$(echo "$PWD_LINE" | grep -o '<password>.*</password>' | sed 's/<password>//;s/<\/password>//' | wc -c)
            echo "✓ Found <password> (${PWD_LENGTH} chars)"
          else
            echo "❌ ERROR: <password> not found!"
            exit 1
          fi
          
          if grep -q 'hasslefree-dev-912675023810.d.codeartifact' ~/.m2/settings.xml; then
            echo "✓ Found CodeArtifact repository URL"
          else
            echo "❌ ERROR: CodeArtifact URL not found!"
            exit 1
          fi
          
          if grep -q '<activeProfile>codeartifact</activeProfile>' ~/.m2/settings.xml; then
            echo "✓ Found activeProfile: codeartifact"
          else
            echo "❌ ERROR: activeProfile not found!"
            exit 1
          fi
          
          echo ""
          echo "=== First 20 lines (password masked) ==="
          sed 's/<password>.*<\/password>/<password>***MASKED**<\/password>/g' ~/.m2/settings.xml | head -20

      - name: Publish to CodeArtifact
        run: |
          echo "=== Publishing to CodeArtifact ==="
          echo "Domain: ${{ env.CODEARTIFACT_DOMAIN }}"
          echo "Repository: ${{ env.CODEARTIFACT_REPOSITORY }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Account: ${{ env.AWS_ACCOUNT_ID }}"
          echo ""
          
          # Verify settings.xml before deploy
          if [ ! -f ~/.m2/settings.xml ]; then
            echo "❌ ERROR: settings.xml not found before deploy!"
            exit 1
          fi
          
          # Show what Maven will use
          echo "Using settings.xml: $(ls -lh ~/.m2/settings.xml)"
          echo ""
          
          # Show the structure of settings.xml (without password)
          echo "=== settings.xml structure (password masked) ==="
          sed 's/<password>.*<\/password>/<password>***MASKED**<\/password>/g' ~/.m2/settings.xml | head -30
          echo ""
          
          # Deploy with maximum verbosity and capture error
          echo "Starting deploy..."
          DEPLOY_LOG=$(mktemp)
          mvn -B deploy \
            -DskipTests \
            --settings ~/.m2/settings.xml \
            2>&1 | tee "$DEPLOY_LOG"
          
          DEPLOY_STATUS=$?
          
          if [ $DEPLOY_STATUS -eq 0 ]; then
            echo ""
            echo "✓ Published successfully"
          else
            echo ""
            echo "❌ Deploy failed with exit code: $DEPLOY_STATUS"
            echo ""
            echo "=== Extracting error message ==="
            # Try to find the actual error
            grep -i "error\|failed\|exception" "$DEPLOY_LOG" | tail -20
            echo ""
            echo "=== Checking Maven settings authentication ==="
            grep -A 2 '<server>' ~/.m2/settings.xml | head -10
            echo ""
            echo "=== AWS Caller Identity ==="
            aws sts get-caller-identity
            echo ""
            echo "=== CodeArtifact Repository ==="
            aws codeartifact describe-repository \
              --domain ${{ env.CODEARTIFACT_DOMAIN }} \
              --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
              --region ${{ env.AWS_REGION }}
            echo ""
            echo "=== Full Maven error log ==="
            cat "$DEPLOY_LOG" | tail -50
            rm -f "$DEPLOY_LOG"
            exit 1
          fi

      - name: Publish Summary
        run: |
          echo "## ✅ Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | ${{ env.CODEARTIFACT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ env.CODEARTIFACT_REPOSITORY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | com.hasslefree:auth-client-lib |" >> $GITHUB_STEP_SUMMARY

      - name: Handle publish failure
        if: failure()
        run: |
          echo "## ❌ Publish Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify AWS credentials: \`aws sts get-caller-identity\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check CodeArtifact domain/repo: \`aws codeartifact describe-repository ...\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check IAM role permissions: \`aws iam get-role-policy ...\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Review Maven debug output: add \`-X\` flag to mvn commands" >> $GITHUB_STEP_SUMMARY

