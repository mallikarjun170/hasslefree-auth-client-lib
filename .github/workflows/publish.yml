name: Publish to AWS CodeArtifact

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 912675023810
  PROJECT_NAME: hasslefree
  CODEARTIFACT_DOMAIN: hasslefree-dev
  CODEARTIFACT_REPOSITORY: maven

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: Publish auth-client-lib to CodeArtifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-${{ github.actor }}-${{ github.run_id }}-codeartifact

      - name: Upgrade AWS CLI
        run: |
          echo "=== Checking AWS CLI version ==="
          aws --version
          echo ""
          echo "=== Upgrading AWS CLI ==="
          pip install --upgrade awscli 2>&1 | tail -5
          echo ""
          echo "=== New AWS CLI version ==="
          aws --version

      - name: Verify CodeArtifact repository exists
        run: |
          echo "=== Checking CodeArtifact repository ==="
          aws codeartifact describe-repository \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --region ${{ env.AWS_REGION }}
          echo "✓ Repository verified"

      - name: Get CodeArtifact authorization token
        run: |
          echo "=== Requesting authorization token ==="
          CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --region ${{ env.AWS_REGION }} \
            --duration-seconds 900 \
            --query authorizationToken \
            --output text)
          
          if [ -z "$CODEARTIFACT_AUTH_TOKEN" ]; then
            echo "❌ ERROR: Failed to obtain CodeArtifact token!"
            echo "AWS Caller Identity:"
            aws sts get-caller-identity
            exit 1
          fi
          
          echo "CODEARTIFACT_AUTH_TOKEN=${CODEARTIFACT_AUTH_TOKEN}" >> $GITHUB_ENV
          TOKEN_LEN=$(echo -n "$CODEARTIFACT_AUTH_TOKEN" | wc -c)
          echo "✓ Token obtained (${TOKEN_LEN} chars)"
          echo "Token format: JWT" 
          echo "Token expires in: 900 seconds"

      - name: Configure Maven for CodeArtifact
        env:
          CODEARTIFACT_TOKEN: ${{ env.CODEARTIFACT_AUTH_TOKEN }}
        run: |
          echo "=== Configuring Maven with CodeArtifact credentials ==="
          
          # Try using aws codeartifact login first
          echo "Attempting: aws codeartifact login --tool maven"
          if aws codeartifact login --tool maven \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} 2>&1; then
            echo "✓ Successfully used aws codeartifact login"
          else
            echo "⚠ aws codeartifact login failed or not supported, using manual approach..."
            
            # Fallback: manual settings.xml creation
            mkdir -p ~/.m2
            
            if [ -z "$CODEARTIFACT_TOKEN" ]; then
              echo "❌ ERROR: CODEARTIFACT_TOKEN is empty!"
              exit 1
            fi
            
            echo "Token length: $(echo -n "$CODEARTIFACT_TOKEN" | wc -c) chars"
            
            # Use Python for safe token substitution
            python3 << 'PYTHON_EOF'
          import os
          
          token = os.environ.get('CODEARTIFACT_TOKEN', '')
          if not token:
              print("❌ ERROR: Token not found in environment!")
              exit(1)
          
          settings_xml = f'''<?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>codeartifact</id>
                <username>aws</username>
                <password>{token}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>codeartifact</id>
                <repositories>
                  <repository>
                    <id>codeartifact</id>
                    <url>https://hasslefree-dev-912675023810.d.codeartifact.us-east-1.amazonaws.com/maven/maven/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>codeartifact</activeProfile>
            </activeProfiles>
          </settings>'''
          
          with open(os.path.expanduser('~/.m2/settings.xml'), 'w') as f:
              f.write(settings_xml)
          
          print(f"✓ settings.xml created with token ({len(token)} chars)")
          PYTHON_EOF
          fi

      - name: Build and Test
        run: mvn -B -ntp clean verify

      - name: Publish to CodeArtifact
        run: |
          echo "=== Publishing to CodeArtifact ==="
          echo "Domain: ${{ env.CODEARTIFACT_DOMAIN }}"
          echo "Repository: ${{ env.CODEARTIFACT_REPOSITORY }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Account: ${{ env.AWS_ACCOUNT_ID }}"
          echo ""
          
          # Verify settings.xml before deploy
          if [ ! -f ~/.m2/settings.xml ]; then
            echo "❌ ERROR: settings.xml not found before deploy!"
            exit 1
          fi
          
          # Show what Maven will use
          echo "Using settings.xml: $(ls -lh ~/.m2/settings.xml)"
          
          # Deploy with maximum verbosity
          echo ""
          echo "Starting deploy..."
          mvn -B deploy \
            -DskipTests \
            -Dorg.slf4j.simpleLogger.defaultLogLevel=debug \
            --settings ~/.m2/settings.xml \
            --errors || {
              echo ""
              echo "❌ Deploy failed"
              echo ""
              echo "Debugging information:"
              echo "=== AWS Caller Identity ==="
              aws sts get-caller-identity
              echo ""
              echo "=== CodeArtifact Repository ==="
              aws codeartifact describe-repository \
                --domain ${{ env.CODEARTIFACT_DOMAIN }} \
                --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
                --region ${{ env.AWS_REGION }}
              exit 1
            }
          
          echo "✓ Published successfully"

      - name: Publish Summary
        run: |
          echo "## ✅ Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | ${{ env.CODEARTIFACT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ env.CODEARTIFACT_REPOSITORY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | com.hasslefree:auth-client-lib |" >> $GITHUB_STEP_SUMMARY

      - name: Handle publish failure
        if: failure()
        run: |
          echo "## ❌ Publish Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify AWS credentials: \`aws sts get-caller-identity\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check CodeArtifact domain/repo: \`aws codeartifact describe-repository ...\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check IAM role permissions: \`aws iam get-role-policy ...\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Review Maven debug output: add \`-X\` flag to mvn commands" >> $GITHUB_STEP_SUMMARY

