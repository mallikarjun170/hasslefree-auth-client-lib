name: Publish to AWS CodeArtifact

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [created]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 912675023810
  PROJECT_NAME: hasslefree
  CODEARTIFACT_DOMAIN: hasslefree-dev
  CODEARTIFACT_REPOSITORY: maven

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: Publish auth-client-lib to CodeArtifact
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-github-actions-role
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-${{ github.actor }}-${{ github.run_id }}-codeartifact

      - name: Verify CodeArtifact repository access
        run: |
          echo "=== CodeArtifact repository endpoint ==="
          aws codeartifact get-repository-endpoint \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} \
            --format maven || true
          echo "=== Describe repository (diagnostic) ==="
          aws codeartifact describe-repository \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} || true

      - name: Login to CodeArtifact (configure Maven)
        run: |
          # This command writes a proper ~/.m2/settings.xml with temporary auth token
          aws codeartifact login --tool maven \
            --domain ${{ env.CODEARTIFACT_DOMAIN }} \
            --domain-owner ${{ env.AWS_ACCOUNT_ID }} \
            --repository ${{ env.CODEARTIFACT_REPOSITORY }} --region ${{ env.AWS_REGION }}

      - name: Show generated Maven settings (masked)
        run: |
          echo "Settings file exists: " && [ -f ~/.m2/settings.xml ] && stat -f%z ~/.m2/settings.xml || stat -c%s ~/.m2/settings.xml || true
          # Print only the top of settings.xml for debugging (do NOT print password)
          sed -n '1,120p' ~/.m2/settings.xml | sed -n '1,120p' || true

      - name: Build and Test
        run: mvn -B -ntp clean verify

      - name: Publish to CodeArtifact
        run: |
          echo "=== Verifying AWS credentials ==="
          aws sts get-caller-identity
          
          echo ""
          echo "=== Verifying Maven settings.xml ==="
          if [ -f ~/.m2/settings.xml ]; then
            echo "Settings file exists"
            echo "Settings file size: $(stat -f%z ~/.m2/settings.xml 2>/dev/null || stat -c%s ~/.m2/settings.xml 2>/dev/null) bytes"
          else
            echo "ERROR: settings.xml not found!"
            exit 1
          fi
          
          echo ""
          echo "=== Running Maven deploy ==="
          mvn -B deploy -DskipTests -q

      - name: Publish Summary
        run: |
          echo "## âœ… Published to CodeArtifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | ${{ env.CODEARTIFACT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ env.CODEARTIFACT_REPOSITORY }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
